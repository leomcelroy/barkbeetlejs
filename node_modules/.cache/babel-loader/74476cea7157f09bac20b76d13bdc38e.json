{"ast":null,"code":"import _toConsumableArray from \"/Users/leomcelroy/Desktop/barkbeetle_js/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\n// makerjs model, depth, params -> pocket toolpath\nimport * as mjs from 'makerjs';\nimport clipperOffset from './clipperOffset.js';\nvar STRANGE_CORRECTION = 0.0000001; //TODO: why is this neccessary otherwise outline shits the bed\n\nvar len = function len(toolpath) {\n  return Object.keys(toolpath.models).length;\n};\n\nvar isToolpath = function isToolpath(toolpath) {\n  //console.log(\"toolpath\", toolpath);\n  if (len(toolpath) === 1) {\n    return true;\n  } else if (len(toolpath) >= 1) {\n    return true;\n  } else {\n    return false;\n  }\n};\n\nvar intToolpath = function intToolpath(geo, radius) {\n  var corners = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 1;\n  // console.log(\"geo\", geo);\n  // console.log(len(geo));\n  // let corners = (len(geo) === 1) ? 1 : 0;\n  var pass;\n\n  try {\n    //pass = mjs.model.outline(geo, radius + STRANGE_CORRECTION, corners, true); //This uses makerjs offsetting tools\n    pass = clipperOffset(geo, -radius, corners); //TODO: this is experiment\n  } catch (_unused) {\n    corners = 0; //pass = mjs.model.outline(geo, radius + STRANGE_CORRECTION, corners, true);\n\n    pass = clipperOffset(geo, -radius, corners); //TODO: this is experiment\n  }\n\n  return pass;\n};\n\nvar intToolpaths = function intToolpaths(geo, params) {\n  var models = {};\n  var count = 0;\n  var pass = intToolpath(geo, params.compensatedRadius);\n\n  if (isToolpath(pass) !== true) {\n    return {\n      models: {}\n    };\n  }\n\n  while (isToolpath(pass)) {\n    models[count] = pass;\n    count++;\n    pass = intToolpath(models[count - 1], params.compensatedRadius * params.stepoverPercentage / 100); //pass = clipperOffset(models[count - 1], -params.compensatedRadius * params.stepoverPercentage/100)\n    //console.log(pass);\n    // this is a strange issue\n    // not entirely sure why mjs has issues with some corner parameters when there are sharp separate corners in model\n    // try {\n    //   pass = intToolpath(models[count - 1], params.compensatedRadius * params.stepoverPercentage, corners);\n    // } catch {\n    //   corners = 0;\n    // }\n    //\n    // if (len(pass) > 1) {\n    //   corners = 0;\n    // }\n    //console.log(\"pass\", pass, \"count\", count, \"ispath\", isToolpath(pass));\n  }\n\n  var model = {\n    models: models //console.log(\"model\", model)\n\n  };\n  return model;\n};\n\nvar pocket = function pocket(model, params) {\n  var p = model;\n  var outlines = intToolpaths(p, params);\n  var iterOut = Object.values(outlines.models);\n  var chains = iterOut.map(function (x) {\n    return mjs.model.findChains(x);\n  });\n  var divisions = chains.map(function (c) {\n    return c.map(function (c2) {\n      return Math.floor(c2.pathLength / params.minimumSpacing);\n    });\n  });\n  var spacing = chains.map(function (c, i) {\n    return c.map(function (c2, j) {\n      return c2.pathLength / divisions[i][j];\n    });\n  });\n  var keyPoints = chains.map(function (c, i) {\n    return c.map(function (c2, j) {\n      return mjs.chain.toKeyPoints(c2, spacing[i][j]);\n    });\n  }); // console.log(keyPoints);\n\n  var gcodePoints = keyPoints.map(function (c) {\n    var raise = c.length > 1;\n    return c.map(function (c2) {\n      var firstPoint = c2[0];\n      firstPoint = \"G1 X\".concat(firstPoint[0], \" Y\").concat(firstPoint[1], \" F\").concat(params.feedRate);\n\n      if (raise) {\n        return [\"G1 Z\".concat(params.jogHeight, \" F\").concat(params.jogRate), firstPoint, //want to jog to this one\n        \"plunge\"].concat(_toConsumableArray(c2.map(function (c3) {\n          return \"G1 X\".concat(c3[0], \" Y\").concat(c3[1], \" F\").concat(params.feedRate);\n        })), [firstPoint, \"G1 Z\".concat(params.jogHeight, \" F\").concat(params.jogRate)]);\n      } else {\n        return [firstPoint, \"plunge\"].concat(_toConsumableArray(c2.map(function (c3) {\n          return \"G1 X\".concat(c3[0], \" Y\").concat(c3[1], \" F\").concat(params.feedRate);\n        })), [firstPoint]);\n      }\n    });\n  });\n  var paths = gcodePoints.flat(1); // let firstPoint = keyPoints[0][0][0];\n\n  var paths2 = params.depthOfPasses.map(function (p, i) {\n    return _toConsumableArray(paths.flat(1).map(function (x) {\n      return x === \"plunge\" ? \"G1 Z\".concat(params.depthOfPasses[i], \" F12.0\") : x;\n    }));\n  }); // console.log(paths2)\n\n  paths2 = paths2.flat(1);\n  var preamble = [params.units, \"G90\"];\n  var gcode = [].concat(preamble, [\"(end of preamble)\", \"G1 Z\".concat(params.jogHeight, \" F\").concat(params.jogRate)], _toConsumableArray(paths2), [\"G1 Z\".concat(params.jogHeight, \" F\").concat(params.jogRate)]); // write to a new file named\n\n  var filename = 'testGcodePocket.gcode';\n  var text = gcode.join('\\n');\n  return {\n    drawing: outlines,\n    gcode: text,\n    filename: filename\n  };\n};\n\nexport { pocket };","map":{"version":3,"sources":["/Users/leomcelroy/Desktop/barkbeetle_js/src/toolpaths/pocket.js"],"names":["mjs","clipperOffset","STRANGE_CORRECTION","len","toolpath","Object","keys","models","length","isToolpath","intToolpath","geo","radius","corners","pass","intToolpaths","params","count","compensatedRadius","stepoverPercentage","model","pocket","p","outlines","iterOut","values","chains","map","x","findChains","divisions","c","c2","Math","floor","pathLength","minimumSpacing","spacing","i","j","keyPoints","chain","toKeyPoints","gcodePoints","raise","firstPoint","feedRate","jogHeight","jogRate","c3","paths","flat","paths2","depthOfPasses","preamble","units","gcode","filename","text","join","drawing"],"mappings":"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","sourcesContent":["// makerjs model, depth, params -> pocket toolpath\nimport * as mjs from 'makerjs';\nimport clipperOffset from './clipperOffset.js';\n\nconst STRANGE_CORRECTION = 0.0000001; //TODO: why is this neccessary otherwise outline shits the bed\n\nconst len = (toolpath) => Object.keys(toolpath.models).length;\n\nconst isToolpath = (toolpath) => {\n  //console.log(\"toolpath\", toolpath);\n\n  if (len(toolpath) === 1) {\n    return true;\n  } else if (len(toolpath) >= 1) {\n    return true;\n  } else {\n    return false;\n  }\n}\n\nconst intToolpath = (geo, radius, corners = 1) => {\n  // console.log(\"geo\", geo);\n  // console.log(len(geo));\n  // let corners = (len(geo) === 1) ? 1 : 0;\n\n  let pass;\n\n  try {\n    //pass = mjs.model.outline(geo, radius + STRANGE_CORRECTION, corners, true); //This uses makerjs offsetting tools\n    pass = clipperOffset(geo, -radius, corners); //TODO: this is experiment\n  } catch {\n    corners = 0;\n    //pass = mjs.model.outline(geo, radius + STRANGE_CORRECTION, corners, true);\n    pass = clipperOffset(geo, -radius, corners); //TODO: this is experiment\n  }\n\n  return pass\n}\n\nconst intToolpaths = (geo, params) => {\n  let models = {}\n  let count = 0;\n\n  let pass = intToolpath(geo, params.compensatedRadius);\n\n  if (isToolpath(pass) !== true) {\n    return {models:{}};\n  }\n\n  while ( isToolpath(pass)) {\n    models[count] = pass;\n    count++;\n    pass = intToolpath(models[count - 1], params.compensatedRadius * params.stepoverPercentage/100);\n    //pass = clipperOffset(models[count - 1], -params.compensatedRadius * params.stepoverPercentage/100)\n    //console.log(pass);\n\n    // this is a strange issue\n    // not entirely sure why mjs has issues with some corner parameters when there are sharp separate corners in model\n    // try {\n    //   pass = intToolpath(models[count - 1], params.compensatedRadius * params.stepoverPercentage, corners);\n    // } catch {\n    //   corners = 0;\n    // }\n    //\n    // if (len(pass) > 1) {\n    //   corners = 0;\n    // }\n\n    //console.log(\"pass\", pass, \"count\", count, \"ispath\", isToolpath(pass));\n  }\n\n  let model = {models}\n\n  //console.log(\"model\", model)\n\n  return model;\n}\n\nconst pocket = (model, params) => {\n  let p = model;\n\n  let outlines = intToolpaths(p, params);\n  let iterOut = Object.values(outlines.models);\n\n  let chains = iterOut.map(x => mjs.model.findChains(x));\n\n  var divisions = chains.map(c => c.map(c2 => Math.floor(c2.pathLength / params.minimumSpacing)));\n\n  var spacing = chains.map((c,i) => c.map((c2, j) => c2.pathLength / divisions[i][j]));\n\n  let keyPoints = chains.map((c, i) => c.map((c2, j) => mjs.chain.toKeyPoints(c2, spacing[i][j])));\n\n  // console.log(keyPoints);\n\n  let gcodePoints = keyPoints.map(c => {\n    let raise = c.length > 1;\n\n    return c.map(c2 => {\n      let firstPoint = c2[0];\n      firstPoint = `G1 X${firstPoint[0]} Y${firstPoint[1]} F${params.feedRate}`;\n\n      if (raise) {\n        return [\n          `G1 Z${params.jogHeight} F${params.jogRate}`,\n          firstPoint, //want to jog to this one\n          \"plunge\",\n          ...c2.map(c3 => `G1 X${c3[0]} Y${c3[1]} F${params.feedRate}`),\n          firstPoint,\n          `G1 Z${params.jogHeight} F${params.jogRate}`,\n        ]\n      } else {\n        return [\n          firstPoint,\n          \"plunge\",\n          ...c2.map(c3 => `G1 X${c3[0]} Y${c3[1]} F${params.feedRate}`),\n          firstPoint\n        ]\n      }\n    });\n  });\n\n  let paths = gcodePoints.flat(1);\n\n  // let firstPoint = keyPoints[0][0][0];\n\n  let paths2 = params.depthOfPasses.map((p,i) => [\n    ...paths.flat(1).map(x => (x === \"plunge\") ? `G1 Z${params.depthOfPasses[i]} F12.0` : x),\n  ])\n\n  // console.log(paths2)\n\n  paths2 = paths2.flat(1);\n\n  let preamble = [params.units, \"G90\"];\n\n  let gcode = [\n    ...preamble,\n    \"(end of preamble)\",\n    `G1 Z${params.jogHeight} F${params.jogRate}`,\n    // `G0 X${firstPoint[0]} Y${firstPoint[1]}`,\n    ...paths2,\n    `G1 Z${params.jogHeight} F${params.jogRate}`,\n  ]\n\n  // write to a new file named\n  let filename = 'testGcodePocket.gcode';\n\n  let text = gcode.join('\\n');\n\n  return {drawing: outlines, gcode: text, filename};\n};\n\n\nexport {pocket};\n"]},"metadata":{},"sourceType":"module"}