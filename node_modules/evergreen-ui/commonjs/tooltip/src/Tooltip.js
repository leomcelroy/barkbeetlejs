"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _lodash = _interopRequireDefault(require("lodash.debounce"));

var _positioner = require("../../positioner");

var _constants = require("../../constants");

var _TooltipStateless = _interopRequireDefault(require("./TooltipStateless"));

var idCounter = 0;

var Tooltip =
/*#__PURE__*/
function (_PureComponent) {
  (0, _inherits2.default)(Tooltip, _PureComponent);

  function Tooltip(props, context) {
    var _this;

    (0, _classCallCheck2.default)(this, Tooltip);
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(Tooltip).call(this, props, context));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "show", function () {
      if (_this.state.isShown) return;

      _this.setState({
        isShown: true
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "hide", function () {
      if (!_this.state.isShown) return;

      _this.setState({
        isShown: false
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "renderTarget", function (_ref) {
      var getRef = _ref.getRef;
      var children = _this.props.children;
      var tooltipTargetProps = {
        onMouseEnter: _this.show,
        onMouseLeave: _this.hide,
        'aria-describedby': _this.state.id
        /**
         * Tooltips can be used within a Popover (not the other way around)
         * When a Tooltip is used within a Popover, the Popover passes
         * its props to the Tooltip in a `popoverProps` object.
         */
        // eslint-disable-next-line react/prop-types

      };

      if (_this.props.popoverProps) {
        var _this$props$popoverPr = _this.props.popoverProps,
            getTargetRef = _this$props$popoverPr.getTargetRef,
            isShown = _this$props$popoverPr.isShown,
            popoverTargetProps = (0, _objectWithoutProperties2.default)(_this$props$popoverPr, ["getTargetRef", "isShown"]);
        return _react.default.cloneElement(children, (0, _objectSpread2.default)({}, popoverTargetProps, tooltipTargetProps, {
          innerRef: function innerRef(ref) {
            // Get the ref for the Tooltip.
            getRef(ref); // Pass the ref to the Popover.

            getTargetRef(ref);
          }
        }));
      }
      /**
       * With normal usage only the props for a Tooltip are passed to the target.
       */


      return _react.default.cloneElement(children, (0, _objectSpread2.default)({}, tooltipTargetProps, {
        innerRef: function innerRef(ref) {
          getRef(ref);
        }
      }));
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "isPopoverShown", function () {
      return (// eslint-disable-next-line react/prop-types
        _this.props.popoverProps && _this.props.popoverProps.isShown
      );
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleMouseEnterTarget", function () {
      _this.setState({
        isShownByTarget: true
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "handleMouseLeaveTarget", function () {
      _this.setState({
        isShownByTarget: false
      });
    });
    _this.state = {
      id: "evergreen-tooltip-".concat(++idCounter),
      isShown: props.isShown,
      isShownByTarget: false
    };
    _this.handleMouseLeaveTarget = (0, _lodash.default)(_this.handleMouseLeaveTarget, _this.props.hideDelay);
    _this.hide = (0, _lodash.default)(_this.hide, _this.props.hideDelay);
    return _this;
  }

  (0, _createClass2.default)(Tooltip, [{
    key: "render",
    value: function render() {
      var _this2 = this;

      var _this$props = this.props,
          appearance = _this$props.appearance,
          isShown = _this$props.isShown,
          content = _this$props.content,
          position = _this$props.position,
          statelessProps = _this$props.statelessProps;
      var _this$state = this.state,
          stateIsShown = _this$state.isShown,
          isShownByTarget = _this$state.isShownByTarget;
      var shown = (isShown || stateIsShown || isShownByTarget) && !this.isPopoverShown(); // Tooltip was explicitly set to not be shown

      if (isShown === false) {
        shown = false;
      }

      return _react.default.createElement(_positioner.Positioner, {
        target: function target(_ref2) {
          var getRef = _ref2.getRef;
          return _this2.renderTarget({
            getRef: getRef
          });
        },
        isShown: shown,
        position: position,
        animationDuration: 160
      }, function (_ref3) {
        var css = _ref3.css,
            style = _ref3.style,
            state = _ref3.state,
            getRef = _ref3.getRef;
        return _react.default.createElement(_TooltipStateless.default, (0, _extends2.default)({
          id: _this2.state.id,
          appearance: appearance,
          innerRef: function innerRef(ref) {
            return getRef(ref);
          },
          "data-state": state,
          css: css,
          style: style,
          onMouseEnter: _this2.handleMouseEnterTarget,
          onMouseLeave: _this2.handleMouseLeaveTarget
        }, statelessProps), content);
      });
    }
  }]);
  return Tooltip;
}(_react.PureComponent);

exports.default = Tooltip;
Tooltip.displayName = "Tooltip";
(0, _defineProperty2.default)(Tooltip, "propTypes", {
  /**
   * The appearance of the tooltip.
   */
  appearance: _propTypes.default.oneOf(['default', 'card']).isRequired,

  /**
   * The position the Popover is on.
   */
  position: _propTypes.default.oneOf([_constants.Position.TOP, _constants.Position.TOP_LEFT, _constants.Position.TOP_RIGHT, _constants.Position.BOTTOM, _constants.Position.BOTTOM_LEFT, _constants.Position.BOTTOM_RIGHT, _constants.Position.LEFT, _constants.Position.RIGHT]),

  /**
   * The content of the Popover.
   */
  content: _propTypes.default.node.isRequired,

  /**
   * Time in ms before hiding the Tooltip.
   */
  hideDelay: _propTypes.default.number.isRequired,

  /**
   * When True, manually show the Tooltip.
   */
  isShown: _propTypes.default.bool,

  /**
   * The target button of the Tooltip.
   */
  children: _propTypes.default.node.isRequired,

  /**
   * Properties passed through to the Tooltip.
   */
  statelessProps: _propTypes.default.object
});
(0, _defineProperty2.default)(Tooltip, "defaultProps", {
  appearance: 'default',
  position: _constants.Position.BOTTOM,
  hideDelay: 120
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90b29sdGlwL3NyYy9Ub29sdGlwLmpzIl0sIm5hbWVzIjpbImlkQ291bnRlciIsIlRvb2x0aXAiLCJwcm9wcyIsImNvbnRleHQiLCJzdGF0ZSIsImlzU2hvd24iLCJzZXRTdGF0ZSIsImdldFJlZiIsImNoaWxkcmVuIiwidG9vbHRpcFRhcmdldFByb3BzIiwib25Nb3VzZUVudGVyIiwic2hvdyIsIm9uTW91c2VMZWF2ZSIsImhpZGUiLCJpZCIsInBvcG92ZXJQcm9wcyIsImdldFRhcmdldFJlZiIsInBvcG92ZXJUYXJnZXRQcm9wcyIsIlJlYWN0IiwiY2xvbmVFbGVtZW50IiwiaW5uZXJSZWYiLCJyZWYiLCJpc1Nob3duQnlUYXJnZXQiLCJoYW5kbGVNb3VzZUxlYXZlVGFyZ2V0IiwiaGlkZURlbGF5IiwiYXBwZWFyYW5jZSIsImNvbnRlbnQiLCJwb3NpdGlvbiIsInN0YXRlbGVzc1Byb3BzIiwic3RhdGVJc1Nob3duIiwic2hvd24iLCJpc1BvcG92ZXJTaG93biIsInJlbmRlclRhcmdldCIsImNzcyIsInN0eWxlIiwiaGFuZGxlTW91c2VFbnRlclRhcmdldCIsIlB1cmVDb21wb25lbnQiLCJQcm9wVHlwZXMiLCJvbmVPZiIsImlzUmVxdWlyZWQiLCJQb3NpdGlvbiIsIlRPUCIsIlRPUF9MRUZUIiwiVE9QX1JJR0hUIiwiQk9UVE9NIiwiQk9UVE9NX0xFRlQiLCJCT1RUT01fUklHSFQiLCJMRUZUIiwiUklHSFQiLCJub2RlIiwibnVtYmVyIiwiYm9vbCIsIm9iamVjdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFNBQVMsR0FBRyxDQUFoQjs7SUFFcUJDLE87Ozs7O0FBcURuQixtQkFBWUMsS0FBWixFQUFtQkMsT0FBbkIsRUFBNEI7QUFBQTs7QUFBQTtBQUMxQiw2R0FBTUQsS0FBTixFQUFhQyxPQUFiO0FBRDBC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LE9BWEgsQ0FERDtBQUFBLE9BUkgsQ0FERjtBQTBCRDs7O0VBbk1rQ1Usb0I7OztBQUFoQm5DLE87OEJBQUFBLE8sZUFDQTtBQUNqQjs7O0FBR0F3QixFQUFBQSxVQUFVLEVBQUVZLG1CQUFVQyxLQUFWLENBQWdCLENBQUMsU0FBRCxFQUFZLE1BQVosQ0FBaEIsRUFBcUNDLFVBSmhDOztBQU1qQjs7O0FBR0FaLEVBQUFBLFFBQVEsRUFBRVUsbUJBQVVDLEtBQVYsQ0FBZ0IsQ0FDeEJFLG9CQUFTQyxHQURlLEVBRXhCRCxvQkFBU0UsUUFGZSxFQUd4QkYsb0JBQVNHLFNBSGUsRUFJeEJILG9CQUFTSSxNQUplLEVBS3hCSixvQkFBU0ssV0FMZSxFQU14Qkwsb0JBQVNNLFlBTmUsRUFPeEJOLG9CQUFTTyxJQVBlLEVBUXhCUCxvQkFBU1EsS0FSZSxDQUFoQixDQVRPOztBQW9CakI7OztBQUdBdEIsRUFBQUEsT0FBTyxFQUFFVyxtQkFBVVksSUFBVixDQUFlVixVQXZCUDs7QUF5QmpCOzs7QUFHQWYsRUFBQUEsU0FBUyxFQUFFYSxtQkFBVWEsTUFBVixDQUFpQlgsVUE1Qlg7O0FBOEJqQjs7O0FBR0FsQyxFQUFBQSxPQUFPLEVBQUVnQyxtQkFBVWMsSUFqQ0Y7O0FBbUNqQjs7O0FBR0EzQyxFQUFBQSxRQUFRLEVBQUU2QixtQkFBVVksSUFBVixDQUFlVixVQXRDUjs7QUF3Q2pCOzs7QUFHQVgsRUFBQUEsY0FBYyxFQUFFUyxtQkFBVWU7QUEzQ1QsQzs4QkFEQW5ELE8sa0JBK0NHO0FBQ3BCd0IsRUFBQUEsVUFBVSxFQUFFLFNBRFE7QUFFcEJFLEVBQUFBLFFBQVEsRUFBRWEsb0JBQVNJLE1BRkM7QUFHcEJwQixFQUFBQSxTQUFTLEVBQUU7QUFIUyxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IFB1cmVDb21wb25lbnQgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCBkZWJvdW5jZSBmcm9tICdsb2Rhc2guZGVib3VuY2UnXG5pbXBvcnQgeyBQb3NpdGlvbmVyIH0gZnJvbSAnLi4vLi4vcG9zaXRpb25lcidcbmltcG9ydCB7IFBvc2l0aW9uIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJ1xuaW1wb3J0IFRvb2x0aXBTdGF0ZWxlc3MgZnJvbSAnLi9Ub29sdGlwU3RhdGVsZXNzJ1xuXG5sZXQgaWRDb3VudGVyID0gMFxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUb29sdGlwIGV4dGVuZHMgUHVyZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIGFwcGVhcmFuY2Ugb2YgdGhlIHRvb2x0aXAuXG4gICAgICovXG4gICAgYXBwZWFyYW5jZTogUHJvcFR5cGVzLm9uZU9mKFsnZGVmYXVsdCcsICdjYXJkJ10pLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgcG9zaXRpb24gdGhlIFBvcG92ZXIgaXMgb24uXG4gICAgICovXG4gICAgcG9zaXRpb246IFByb3BUeXBlcy5vbmVPZihbXG4gICAgICBQb3NpdGlvbi5UT1AsXG4gICAgICBQb3NpdGlvbi5UT1BfTEVGVCxcbiAgICAgIFBvc2l0aW9uLlRPUF9SSUdIVCxcbiAgICAgIFBvc2l0aW9uLkJPVFRPTSxcbiAgICAgIFBvc2l0aW9uLkJPVFRPTV9MRUZULFxuICAgICAgUG9zaXRpb24uQk9UVE9NX1JJR0hULFxuICAgICAgUG9zaXRpb24uTEVGVCxcbiAgICAgIFBvc2l0aW9uLlJJR0hUXG4gICAgXSksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgY29udGVudCBvZiB0aGUgUG9wb3Zlci5cbiAgICAgKi9cbiAgICBjb250ZW50OiBQcm9wVHlwZXMubm9kZS5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtcyBiZWZvcmUgaGlkaW5nIHRoZSBUb29sdGlwLlxuICAgICAqL1xuICAgIGhpZGVEZWxheTogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogV2hlbiBUcnVlLCBtYW51YWxseSBzaG93IHRoZSBUb29sdGlwLlxuICAgICAqL1xuICAgIGlzU2hvd246IFByb3BUeXBlcy5ib29sLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHRhcmdldCBidXR0b24gb2YgdGhlIFRvb2x0aXAuXG4gICAgICovXG4gICAgY2hpbGRyZW46IFByb3BUeXBlcy5ub2RlLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBQcm9wZXJ0aWVzIHBhc3NlZCB0aHJvdWdoIHRvIHRoZSBUb29sdGlwLlxuICAgICAqL1xuICAgIHN0YXRlbGVzc1Byb3BzOiBQcm9wVHlwZXMub2JqZWN0XG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIGFwcGVhcmFuY2U6ICdkZWZhdWx0JyxcbiAgICBwb3NpdGlvbjogUG9zaXRpb24uQk9UVE9NLFxuICAgIGhpZGVEZWxheTogMTIwXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xuICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KVxuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGlkOiBgZXZlcmdyZWVuLXRvb2x0aXAtJHsrK2lkQ291bnRlcn1gLFxuICAgICAgaXNTaG93bjogcHJvcHMuaXNTaG93bixcbiAgICAgIGlzU2hvd25CeVRhcmdldDogZmFsc2VcbiAgICB9XG5cbiAgICB0aGlzLmhhbmRsZU1vdXNlTGVhdmVUYXJnZXQgPSBkZWJvdW5jZShcbiAgICAgIHRoaXMuaGFuZGxlTW91c2VMZWF2ZVRhcmdldCxcbiAgICAgIHRoaXMucHJvcHMuaGlkZURlbGF5XG4gICAgKVxuXG4gICAgdGhpcy5oaWRlID0gZGVib3VuY2UodGhpcy5oaWRlLCB0aGlzLnByb3BzLmhpZGVEZWxheSlcbiAgfVxuXG4gIHNob3cgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuc3RhdGUuaXNTaG93bikgcmV0dXJuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBpc1Nob3duOiB0cnVlXG4gICAgfSlcbiAgfVxuXG4gIGhpZGUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnN0YXRlLmlzU2hvd24pIHJldHVyblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNTaG93bjogZmFsc2VcbiAgICB9KVxuICB9XG5cbiAgcmVuZGVyVGFyZ2V0ID0gKHsgZ2V0UmVmIH0pID0+IHtcbiAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSB0aGlzLnByb3BzXG5cbiAgICBjb25zdCB0b29sdGlwVGFyZ2V0UHJvcHMgPSB7XG4gICAgICBvbk1vdXNlRW50ZXI6IHRoaXMuc2hvdyxcbiAgICAgIG9uTW91c2VMZWF2ZTogdGhpcy5oaWRlLFxuICAgICAgJ2FyaWEtZGVzY3JpYmVkYnknOiB0aGlzLnN0YXRlLmlkXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVG9vbHRpcHMgY2FuIGJlIHVzZWQgd2l0aGluIGEgUG9wb3ZlciAobm90IHRoZSBvdGhlciB3YXkgYXJvdW5kKVxuICAgICAqIFdoZW4gYSBUb29sdGlwIGlzIHVzZWQgd2l0aGluIGEgUG9wb3ZlciwgdGhlIFBvcG92ZXIgcGFzc2VzXG4gICAgICogaXRzIHByb3BzIHRvIHRoZSBUb29sdGlwIGluIGEgYHBvcG92ZXJQcm9wc2Agb2JqZWN0LlxuICAgICAqL1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC9wcm9wLXR5cGVzXG4gICAgaWYgKHRoaXMucHJvcHMucG9wb3ZlclByb3BzKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC9wcm9wLXR5cGVzXG4gICAgICAgIGdldFRhcmdldFJlZixcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0L3Byb3AtdHlwZXNcbiAgICAgICAgaXNTaG93bixcbiAgICAgICAgLi4ucG9wb3ZlclRhcmdldFByb3BzXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC9wcm9wLXR5cGVzXG4gICAgICB9ID0gdGhpcy5wcm9wcy5wb3BvdmVyUHJvcHNcblxuICAgICAgcmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudChjaGlsZHJlbiwge1xuICAgICAgICAvLyBBZGQgdGhlIFBvcG92ZXIgcHJvcHMgdG8gdGhlIHRhcmdldC5cbiAgICAgICAgLi4ucG9wb3ZlclRhcmdldFByb3BzLFxuICAgICAgICAvLyBBZGQgdGhlIFRvb2x0aXAgcHJvcHMgdG8gdGhlIHRhcmdldC5cbiAgICAgICAgLi4udG9vbHRpcFRhcmdldFByb3BzLFxuXG4gICAgICAgIGlubmVyUmVmOiByZWYgPT4ge1xuICAgICAgICAgIC8vIEdldCB0aGUgcmVmIGZvciB0aGUgVG9vbHRpcC5cbiAgICAgICAgICBnZXRSZWYocmVmKVxuICAgICAgICAgIC8vIFBhc3MgdGhlIHJlZiB0byB0aGUgUG9wb3Zlci5cbiAgICAgICAgICBnZXRUYXJnZXRSZWYocmVmKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdpdGggbm9ybWFsIHVzYWdlIG9ubHkgdGhlIHByb3BzIGZvciBhIFRvb2x0aXAgYXJlIHBhc3NlZCB0byB0aGUgdGFyZ2V0LlxuICAgICAqL1xuICAgIHJldHVybiBSZWFjdC5jbG9uZUVsZW1lbnQoY2hpbGRyZW4sIHtcbiAgICAgIC4uLnRvb2x0aXBUYXJnZXRQcm9wcyxcbiAgICAgIGlubmVyUmVmOiByZWYgPT4ge1xuICAgICAgICBnZXRSZWYocmVmKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBpc1BvcG92ZXJTaG93biA9ICgpID0+XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0L3Byb3AtdHlwZXNcbiAgICB0aGlzLnByb3BzLnBvcG92ZXJQcm9wcyAmJiB0aGlzLnByb3BzLnBvcG92ZXJQcm9wcy5pc1Nob3duXG5cbiAgaGFuZGxlTW91c2VFbnRlclRhcmdldCA9ICgpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGlzU2hvd25CeVRhcmdldDogdHJ1ZVxuICAgIH0pXG4gIH1cblxuICBoYW5kbGVNb3VzZUxlYXZlVGFyZ2V0ID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNTaG93bkJ5VGFyZ2V0OiBmYWxzZVxuICAgIH0pXG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgYXBwZWFyYW5jZSxcbiAgICAgIGlzU2hvd24sXG4gICAgICBjb250ZW50LFxuICAgICAgcG9zaXRpb24sXG4gICAgICBzdGF0ZWxlc3NQcm9wc1xuICAgIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgeyBpc1Nob3duOiBzdGF0ZUlzU2hvd24sIGlzU2hvd25CeVRhcmdldCB9ID0gdGhpcy5zdGF0ZVxuXG4gICAgbGV0IHNob3duID1cbiAgICAgIChpc1Nob3duIHx8IHN0YXRlSXNTaG93biB8fCBpc1Nob3duQnlUYXJnZXQpICYmICF0aGlzLmlzUG9wb3ZlclNob3duKClcblxuICAgIC8vIFRvb2x0aXAgd2FzIGV4cGxpY2l0bHkgc2V0IHRvIG5vdCBiZSBzaG93blxuICAgIGlmIChpc1Nob3duID09PSBmYWxzZSkge1xuICAgICAgc2hvd24gPSBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICA8UG9zaXRpb25lclxuICAgICAgICB0YXJnZXQ9eyh7IGdldFJlZiB9KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGFyZ2V0KHsgZ2V0UmVmIH0pXG4gICAgICAgIH19XG4gICAgICAgIGlzU2hvd249e3Nob3dufVxuICAgICAgICBwb3NpdGlvbj17cG9zaXRpb259XG4gICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uPXsxNjB9XG4gICAgICA+XG4gICAgICAgIHsoeyBjc3MsIHN0eWxlLCBzdGF0ZSwgZ2V0UmVmIH0pID0+IChcbiAgICAgICAgICA8VG9vbHRpcFN0YXRlbGVzc1xuICAgICAgICAgICAgaWQ9e3RoaXMuc3RhdGUuaWR9XG4gICAgICAgICAgICBhcHBlYXJhbmNlPXthcHBlYXJhbmNlfVxuICAgICAgICAgICAgaW5uZXJSZWY9e3JlZiA9PiBnZXRSZWYocmVmKX1cbiAgICAgICAgICAgIGRhdGEtc3RhdGU9e3N0YXRlfVxuICAgICAgICAgICAgY3NzPXtjc3N9XG4gICAgICAgICAgICBzdHlsZT17c3R5bGV9XG4gICAgICAgICAgICBvbk1vdXNlRW50ZXI9e3RoaXMuaGFuZGxlTW91c2VFbnRlclRhcmdldH1cbiAgICAgICAgICAgIG9uTW91c2VMZWF2ZT17dGhpcy5oYW5kbGVNb3VzZUxlYXZlVGFyZ2V0fVxuICAgICAgICAgICAgey4uLnN0YXRlbGVzc1Byb3BzfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtjb250ZW50fVxuICAgICAgICAgIDwvVG9vbHRpcFN0YXRlbGVzcz5cbiAgICAgICAgKX1cbiAgICAgIDwvUG9zaXRpb25lcj5cbiAgICApXG4gIH1cbn1cbiJdfQ==