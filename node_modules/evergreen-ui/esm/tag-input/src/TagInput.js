import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
import _extends from "@babel/runtime/helpers/esm/extends";
import _classCallCheck from "@babel/runtime/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime/helpers/esm/createClass";
import _possibleConstructorReturn from "@babel/runtime/helpers/esm/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime/helpers/esm/getPrototypeOf";
import _assertThisInitialized from "@babel/runtime/helpers/esm/assertThisInitialized";
import _inherits from "@babel/runtime/helpers/esm/inherits";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";

/**
 * @overview TagInput accepts multiple values that can be individually removed
 */
import React from 'react';
import PropTypes from 'prop-types';
import Box from 'ui-box';
import cx from 'classnames';
import { Text } from '../../typography';
import { withTheme } from '../../theme';
import { majorScale } from '../../scales';
import safeInvoke from '../../lib/safe-invoke';
import Tag from './Tag';
var inputId = 1;

var TagInput =
/*#__PURE__*/
function (_React$Component) {
  _inherits(TagInput, _React$Component);

  function TagInput() {
    var _getPrototypeOf2;

    var _this;

    _classCallCheck(this, TagInput);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(TagInput)).call.apply(_getPrototypeOf2, [this].concat(args)));

    _defineProperty(_assertThisInitialized(_this), "state", {
      inputValue: '',
      isFocused: false
    });

    _defineProperty(_assertThisInitialized(_this), "id", "TagInput-".concat(inputId++));

    _defineProperty(_assertThisInitialized(_this), "addTags", function () {
      var value = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';
      var _this$props = _this.props,
          onAdd = _this$props.onAdd,
          onChange = _this$props.onChange,
          values = _this$props.values;

      var newValues = _this.getValues(value);

      var shouldClearInput = safeInvoke(onAdd, newValues);

      if (typeof onChange === 'function') {
        shouldClearInput = shouldClearInput || onChange(values.concat(newValues));
      }

      if (shouldClearInput !== false) {
        _this.setState({
          inputValue: ''
        });
      }
    });

    _defineProperty(_assertThisInitialized(_this), "getValues", function () {
      var inputValue = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';
      var separator = _this.props.separator;
      return separator ? inputValue.split(separator).map(function (v) {
        return v.trim();
      }).filter(function (v) {
        return v.length > 0;
      }) : [inputValue];
    });

    _defineProperty(_assertThisInitialized(_this), "handleBackspaceToRemove", function () {
      var values = _this.props.values; // Delete last item in values

      _this.removeTagAtIndex(values.length - 1);
    });

    _defineProperty(_assertThisInitialized(_this), "handleBlur", function (event) {
      var container = event.target; // Use raf so that the dom has time to update `activeElement`

      requestAnimationFrame(function () {
        if (!container.contains(document.activeElement)) {
          if (_this.props.addOnBlur && _this.state.inputValue) {
            _this.addTags(_this.state.inputValue);
          }

          _this.setState({
            isFocused: false
          });
        }
      });
      safeInvoke(_this.props.onBlur, event);
    });

    _defineProperty(_assertThisInitialized(_this), "handleInputChange", function (event) {
      _this.setState({
        inputValue: event.target.value
      });

      safeInvoke(_this.props.onInputChange, event);
    });

    _defineProperty(_assertThisInitialized(_this), "handleInputFocus", function (event) {
      _this.setState({
        isFocused: true
      });

      safeInvoke(_this.props.onFocus, event);
    });

    _defineProperty(_assertThisInitialized(_this), "handleKeyDown", function (event) {
      var _event$target = event.target,
          selectionEnd = _event$target.selectionEnd,
          value = _event$target.value;

      if (event.key === 'Enter') {
        // Prevent Enter keypresses from submitting forms since they have special powers inside TagInput
        event.preventDefault();

        _this.addTags(value);
      } else if (event.key === 'Backspace' && selectionEnd === 0) {
        _this.handleBackspaceToRemove(event);
      }
    });

    _defineProperty(_assertThisInitialized(_this), "handleRemoveTag", function (event) {
      // Using data attribute to simplify callback logic -- one handler for all children
      var index = Number(event.currentTarget.parentElement.getAttribute('data-tag-index'));

      _this.removeTagAtIndex(index);
    });

    _defineProperty(_assertThisInitialized(_this), "maybeRenderTag", function (tag, index) {
      if (!tag) {
        return null;
      }

      var _this$props2 = _this.props,
          disabled = _this$props2.disabled,
          tagProps = _this$props2.tagProps;
      var props = safeInvoke(tagProps, tag, index) || tagProps;
      return React.createElement(Tag, _extends({
        key: "".concat(tag, ":").concat(index),
        "data-tag-index": index,
        marginRight: majorScale(1),
        marginY: "6px",
        onRemove: disabled ? null : _this.handleRemoveTag,
        isRemovable: !disabled
      }, props), tag);
    });

    _defineProperty(_assertThisInitialized(_this), "removeTagAtIndex", function (index) {
      var _this$props3 = _this.props,
          onChange = _this$props3.onChange,
          onRemove = _this$props3.onRemove,
          values = _this$props3.values;
      safeInvoke(onRemove, values[index], index); // Remove item at index as a new array

      var newValues = values.filter(function (_, i) {
        return i !== index;
      });
      safeInvoke(onChange, newValues);
    });

    _defineProperty(_assertThisInitialized(_this), "setRef", function (node) {
      _this.input = node;
      safeInvoke(_this.props.inputRef, node);
    });

    return _this;
  }

  _createClass(TagInput, [{
    key: "render",
    value: function render() {
      var _this$props4 = this.props,
          addOnBlur = _this$props4.addOnBlur,
          className = _this$props4.className,
          disabled = _this$props4.disabled,
          height = _this$props4.height,
          inputProps = _this$props4.inputProps,
          inputRef = _this$props4.inputRef,
          onAdd = _this$props4.onAdd,
          onChange = _this$props4.onChange,
          onInputChange = _this$props4.onInputChange,
          onRemove = _this$props4.onRemove,
          separator = _this$props4.separator,
          tagProps = _this$props4.tagProps,
          theme = _this$props4.theme,
          values = _this$props4.values,
          props = _objectWithoutProperties(_this$props4, ["addOnBlur", "className", "disabled", "height", "inputProps", "inputRef", "onAdd", "onChange", "onInputChange", "onRemove", "separator", "tagProps", "theme", "values"]);

      var _this$state = this.state,
          inputValue = _this$state.inputValue,
          isFocused = _this$state.isFocused;
      var themedContainerClassName = theme.getTagInputClassName('default');
      var themedInputClassName = theme.getTextInputClassName('none');
      var textSize = theme.getTextSizeForControlHeight(height);
      var borderRadius = theme.getBorderRadiusForControlHeight(height);
      return React.createElement(Box, _extends({
        "aria-disabled": disabled || undefined,
        "aria-activedescendant": isFocused ? this.id : undefined,
        borderRadius: borderRadius,
        className: cx(themedContainerClassName, className),
        paddingLeft: Math.round(height / 3.2),
        paddingRight: Math.round(height / 3.2),
        paddingY: "2px"
      }, props, {
        onBlur: this.handleBlur
      }), values.map(this.maybeRenderTag), React.createElement(Text, _extends({
        is: "input",
        id: this.id,
        color: disabled ? 'muted' : undefined,
        disabled: disabled,
        flexGrow: "1",
        height: height - 4,
        size: textSize,
        type: "text",
        value: inputValue
      }, inputProps, {
        className: themedInputClassName,
        ref: this.setRef,
        onChange: this.handleInputChange,
        onFocus: this.handleInputFocus,
        onKeyDown: this.handleKeyDown
      })));
    }
  }]);

  return TagInput;
}(React.Component);

TagInput.displayName = "TagInput";

_defineProperty(TagInput, "propTypes", {
  /** Whether or not the inputValue should be added to the tags when the input blurs. */
  addOnBlur: PropTypes.bool,

  /** The class name to apply to the container component. */
  className: PropTypes.string,

  /** Whether or not the input should be disabled. */
  disabled: PropTypes.bool,

  /** The vertical size of the input */
  height: PropTypes.number,

  /** Props to pass to the input component. Note that `ref` and `key` are not supported. See `inputRef`. */
  inputProps: PropTypes.object,

  /**
   * Ref handler for the <input> element.
   * (input: HTMLInputElement | null) => void
   */
  inputRef: PropTypes.func,

  /**
   * Callback invoked when new tags are added.
   * Returning `false` will prevent clearing the input.
   * (values: Array) => void | false
   */
  onAdd: PropTypes.func,

  /**
   * Callback invoked when focus on the input blurs.
   * (event) => void
   */
  onBlur: PropTypes.func,

  /**
   * Callback invoked when the tag values change.
   * Returning `false` will prevent clearing the input.
   * (values: Array) => void | false
   */
  onChange: PropTypes.func,

  /**
   * Callback invoked when the input receives focus.
   * (event) => void
   */
  onFocus: PropTypes.func,

  /**
   * Callback invoked when the value of the <input> is changed. Shorthand for `inputProps={{ onChange }}`.
   * (event) => void
   */
  onInputChange: PropTypes.func,

  /**
   * Callback invoked when a tag is removed.
   * Receives value and index of removed tag.
   * (value: string | node, index: number) => void
   */
  onRemove: PropTypes.func,

  /** Value or RegExp to split on pasted text or on enter keypress */
  separator: PropTypes.oneOfType([PropTypes.string, PropTypes.instanceOf(RegExp), PropTypes.oneOf([false])]),

  /** Provide props to tag component (actually `Badge`, for now). */
  tagProps: PropTypes.oneOfType([PropTypes.object, PropTypes.func]),

  /**
   * Theme provided by ThemeProvider.
   */
  theme: PropTypes.object.isRequired,

  /** Controlled tag values. Each value is rendered inside a tag. */
  values: PropTypes.arrayOf(PropTypes.node)
});

_defineProperty(TagInput, "defaultProps", {
  addOnBlur: false,
  disabled: false,
  height: 32,
  separator: /[,\n\r]/,
  values: [],
  tagProps: {}
});

export default withTheme(TagInput);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWctaW5wdXQvc3JjL1RhZ0lucHV0LmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwiUHJvcFR5cGVzIiwiQm94IiwiY3giLCJUZXh0Iiwid2l0aFRoZW1lIiwibWFqb3JTY2FsZSIsInNhZmVJbnZva2UiLCJUYWciLCJpbnB1dElkIiwiVGFnSW5wdXQiLCJpbnB1dFZhbHVlIiwiaXNGb2N1c2VkIiwidmFsdWUiLCJwcm9wcyIsIm9uQWRkIiwib25DaGFuZ2UiLCJ2YWx1ZXMiLCJuZXdWYWx1ZXMiLCJnZXRWYWx1ZXMiLCJzaG91bGRDbGVhcklucHV0IiwiY29uY2F0Iiwic2V0U3RhdGUiLCJzZXBhcmF0b3IiLCJzcGxpdCIsIm1hcCIsInYiLCJ0cmltIiwiZmlsdGVyIiwibGVuZ3RoIiwicmVtb3ZlVGFnQXRJbmRleCIsImV2ZW50IiwiY29udGFpbmVyIiwidGFyZ2V0IiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiY29udGFpbnMiLCJkb2N1bWVudCIsImFjdGl2ZUVsZW1lbnQiLCJhZGRPbkJsdXIiLCJzdGF0ZSIsImFkZFRhZ3MiLCJvbkJsdXIiLCJvbklucHV0Q2hhbmdlIiwib25Gb2N1cyIsInNlbGVjdGlvbkVuZCIsImtleSIsInByZXZlbnREZWZhdWx0IiwiaGFuZGxlQmFja3NwYWNlVG9SZW1vdmUiLCJpbmRleCIsIk51bWJlciIsImN1cnJlbnRUYXJnZXQiLCJwYXJlbnRFbGVtZW50IiwiZ2V0QXR0cmlidXRlIiwidGFnIiwiZGlzYWJsZWQiLCJ0YWdQcm9wcyIsImhhbmRsZVJlbW92ZVRhZyIsIm9uUmVtb3ZlIiwiXyIsImkiLCJub2RlIiwiaW5wdXQiLCJpbnB1dFJlZiIsImNsYXNzTmFtZSIsImhlaWdodCIsImlucHV0UHJvcHMiLCJ0aGVtZSIsInRoZW1lZENvbnRhaW5lckNsYXNzTmFtZSIsImdldFRhZ0lucHV0Q2xhc3NOYW1lIiwidGhlbWVkSW5wdXRDbGFzc05hbWUiLCJnZXRUZXh0SW5wdXRDbGFzc05hbWUiLCJ0ZXh0U2l6ZSIsImdldFRleHRTaXplRm9yQ29udHJvbEhlaWdodCIsImJvcmRlclJhZGl1cyIsImdldEJvcmRlclJhZGl1c0ZvckNvbnRyb2xIZWlnaHQiLCJ1bmRlZmluZWQiLCJpZCIsIk1hdGgiLCJyb3VuZCIsImhhbmRsZUJsdXIiLCJtYXliZVJlbmRlclRhZyIsInNldFJlZiIsImhhbmRsZUlucHV0Q2hhbmdlIiwiaGFuZGxlSW5wdXRGb2N1cyIsImhhbmRsZUtleURvd24iLCJDb21wb25lbnQiLCJib29sIiwic3RyaW5nIiwibnVtYmVyIiwib2JqZWN0IiwiZnVuYyIsIm9uZU9mVHlwZSIsImluc3RhbmNlT2YiLCJSZWdFeHAiLCJvbmVPZiIsImlzUmVxdWlyZWQiLCJhcnJheU9mIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7OztBQUlBLE9BQU9BLEtBQVAsTUFBa0IsT0FBbEI7QUFDQSxPQUFPQyxTQUFQLE1BQXNCLFlBQXRCO0FBQ0EsT0FBT0MsR0FBUCxNQUFnQixRQUFoQjtBQUNBLE9BQU9DLEVBQVAsTUFBZSxZQUFmO0FBQ0EsU0FBU0MsSUFBVCxRQUFxQixrQkFBckI7QUFDQSxTQUFTQyxTQUFULFFBQTBCLGFBQTFCO0FBQ0EsU0FBU0MsVUFBVCxRQUEyQixjQUEzQjtBQUNBLE9BQU9DLFVBQVAsTUFBdUIsdUJBQXZCO0FBQ0EsT0FBT0MsR0FBUCxNQUFnQixPQUFoQjtBQUVBLElBQUlDLE9BQU8sR0FBRyxDQUFkOztJQUVNQyxROzs7Ozs7Ozs7Ozs7Ozs7Ozs7NERBMkVJO0FBQ05DLE1BQUFBLFVBQVUsRUFBRSxFQUROO0FBRU5DLE1BQUFBLFNBQVMsRUFBRTtBQUZMLEs7OzRFQUtTSCxPQUFPLEU7OzhEQUVkLFlBQWdCO0FBQUEsVUFBZkksS0FBZSx1RUFBUCxFQUFPO0FBQUEsd0JBQ1ksTUFBS0MsS0FEakI7QUFBQSxVQUNoQkMsS0FEZ0IsZUFDaEJBLEtBRGdCO0FBQUEsVUFDVEMsUUFEUyxlQUNUQSxRQURTO0FBQUEsVUFDQ0MsTUFERCxlQUNDQSxNQUREOztBQUV4QixV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MkNqQjs7Ozs7QUFLQWpDLEVBQUFBLFFBQVEsRUFBRXhELFNBQVMsQ0FBQ3lGLElBaERIOztBQWlEakI7QUFDQW5FLEVBQUFBLFNBQVMsRUFBRXRCLFNBQVMsQ0FBQzBGLFNBQVYsQ0FBb0IsQ0FDN0IxRixTQUFTLENBQUNzRixNQURtQixFQUU3QnRGLFNBQVMsQ0FBQzJGLFVBQVYsQ0FBcUJDLE1BQXJCLENBRjZCLEVBRzdCNUYsU0FBUyxDQUFDNkYsS0FBVixDQUFnQixDQUFDLEtBQUQsQ0FBaEIsQ0FINkIsQ0FBcEIsQ0FsRE07O0FBdURqQjtBQUNBdkMsRUFBQUEsUUFBUSxFQUFFdEQsU0FBUyxDQUFDMEYsU0FBVixDQUFvQixDQUFDMUYsU0FBUyxDQUFDd0YsTUFBWCxFQUFtQnhGLFNBQVMsQ0FBQ3lGLElBQTdCLENBQXBCLENBeERPOztBQXlEakI7OztBQUdBeEIsRUFBQUEsS0FBSyxFQUFFakUsU0FBUyxDQUFDd0YsTUFBVixDQUFpQk0sVUE1RFA7O0FBNkRqQjtBQUNBOUUsRUFBQUEsTUFBTSxFQUFFaEIsU0FBUyxDQUFDK0YsT0FBVixDQUFrQi9GLFNBQVMsQ0FBQzJELElBQTVCO0FBOURTLEM7O2dCQURmbEQsUSxrQkFrRWtCO0FBQ3BCNEIsRUFBQUEsU0FBUyxFQUFFLEtBRFM7QUFFcEJnQixFQUFBQSxRQUFRLEVBQUUsS0FGVTtBQUdwQlUsRUFBQUEsTUFBTSxFQUFFLEVBSFk7QUFJcEJ6QyxFQUFBQSxTQUFTLEVBQUUsU0FKUztBQUtwQk4sRUFBQUEsTUFBTSxFQUFFLEVBTFk7QUFNcEJzQyxFQUFBQSxRQUFRLEVBQUU7QUFOVSxDOztBQWlNeEIsZUFBZWxELFNBQVMsQ0FBQ0ssUUFBRCxDQUF4QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQG92ZXJ2aWV3IFRhZ0lucHV0IGFjY2VwdHMgbXVsdGlwbGUgdmFsdWVzIHRoYXQgY2FuIGJlIGluZGl2aWR1YWxseSByZW1vdmVkXG4gKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IEJveCBmcm9tICd1aS1ib3gnXG5pbXBvcnQgY3ggZnJvbSAnY2xhc3NuYW1lcydcbmltcG9ydCB7IFRleHQgfSBmcm9tICcuLi8uLi90eXBvZ3JhcGh5J1xuaW1wb3J0IHsgd2l0aFRoZW1lIH0gZnJvbSAnLi4vLi4vdGhlbWUnXG5pbXBvcnQgeyBtYWpvclNjYWxlIH0gZnJvbSAnLi4vLi4vc2NhbGVzJ1xuaW1wb3J0IHNhZmVJbnZva2UgZnJvbSAnLi4vLi4vbGliL3NhZmUtaW52b2tlJ1xuaW1wb3J0IFRhZyBmcm9tICcuL1RhZydcblxubGV0IGlucHV0SWQgPSAxXG5cbmNsYXNzIFRhZ0lucHV0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAvKiogV2hldGhlciBvciBub3QgdGhlIGlucHV0VmFsdWUgc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSB0YWdzIHdoZW4gdGhlIGlucHV0IGJsdXJzLiAqL1xuICAgIGFkZE9uQmx1cjogUHJvcFR5cGVzLmJvb2wsXG4gICAgLyoqIFRoZSBjbGFzcyBuYW1lIHRvIGFwcGx5IHRvIHRoZSBjb250YWluZXIgY29tcG9uZW50LiAqL1xuICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAvKiogV2hldGhlciBvciBub3QgdGhlIGlucHV0IHNob3VsZCBiZSBkaXNhYmxlZC4gKi9cbiAgICBkaXNhYmxlZDogUHJvcFR5cGVzLmJvb2wsXG4gICAgLyoqIFRoZSB2ZXJ0aWNhbCBzaXplIG9mIHRoZSBpbnB1dCAqL1xuICAgIGhlaWdodDogUHJvcFR5cGVzLm51bWJlcixcbiAgICAvKiogUHJvcHMgdG8gcGFzcyB0byB0aGUgaW5wdXQgY29tcG9uZW50LiBOb3RlIHRoYXQgYHJlZmAgYW5kIGBrZXlgIGFyZSBub3Qgc3VwcG9ydGVkLiBTZWUgYGlucHV0UmVmYC4gKi9cbiAgICBpbnB1dFByb3BzOiBQcm9wVHlwZXMub2JqZWN0LFxuICAgIC8qKlxuICAgICAqIFJlZiBoYW5kbGVyIGZvciB0aGUgPGlucHV0PiBlbGVtZW50LlxuICAgICAqIChpbnB1dDogSFRNTElucHV0RWxlbWVudCB8IG51bGwpID0+IHZvaWRcbiAgICAgKi9cbiAgICBpbnB1dFJlZjogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIG5ldyB0YWdzIGFyZSBhZGRlZC5cbiAgICAgKiBSZXR1cm5pbmcgYGZhbHNlYCB3aWxsIHByZXZlbnQgY2xlYXJpbmcgdGhlIGlucHV0LlxuICAgICAqICh2YWx1ZXM6IEFycmF5KSA9PiB2b2lkIHwgZmFsc2VcbiAgICAgKi9cbiAgICBvbkFkZDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIGZvY3VzIG9uIHRoZSBpbnB1dCBibHVycy5cbiAgICAgKiAoZXZlbnQpID0+IHZvaWRcbiAgICAgKi9cbiAgICBvbkJsdXI6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGludm9rZWQgd2hlbiB0aGUgdGFnIHZhbHVlcyBjaGFuZ2UuXG4gICAgICogUmV0dXJuaW5nIGBmYWxzZWAgd2lsbCBwcmV2ZW50IGNsZWFyaW5nIHRoZSBpbnB1dC5cbiAgICAgKiAodmFsdWVzOiBBcnJheSkgPT4gdm9pZCB8IGZhbHNlXG4gICAgICovXG4gICAgb25DaGFuZ2U6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGludm9rZWQgd2hlbiB0aGUgaW5wdXQgcmVjZWl2ZXMgZm9jdXMuXG4gICAgICogKGV2ZW50KSA9PiB2b2lkXG4gICAgICovXG4gICAgb25Gb2N1czogUHJvcFR5cGVzLmZ1bmMsXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIHRoZSB2YWx1ZSBvZiB0aGUgPGlucHV0PiBpcyBjaGFuZ2VkLiBTaG9ydGhhbmQgZm9yIGBpbnB1dFByb3BzPXt7IG9uQ2hhbmdlIH19YC5cbiAgICAgKiAoZXZlbnQpID0+IHZvaWRcbiAgICAgKi9cbiAgICBvbklucHV0Q2hhbmdlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBpbnZva2VkIHdoZW4gYSB0YWcgaXMgcmVtb3ZlZC5cbiAgICAgKiBSZWNlaXZlcyB2YWx1ZSBhbmQgaW5kZXggb2YgcmVtb3ZlZCB0YWcuXG4gICAgICogKHZhbHVlOiBzdHJpbmcgfCBub2RlLCBpbmRleDogbnVtYmVyKSA9PiB2b2lkXG4gICAgICovXG4gICAgb25SZW1vdmU6IFByb3BUeXBlcy5mdW5jLFxuICAgIC8qKiBWYWx1ZSBvciBSZWdFeHAgdG8gc3BsaXQgb24gcGFzdGVkIHRleHQgb3Igb24gZW50ZXIga2V5cHJlc3MgKi9cbiAgICBzZXBhcmF0b3I6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIFByb3BUeXBlcy5pbnN0YW5jZU9mKFJlZ0V4cCksXG4gICAgICBQcm9wVHlwZXMub25lT2YoW2ZhbHNlXSlcbiAgICBdKSxcbiAgICAvKiogUHJvdmlkZSBwcm9wcyB0byB0YWcgY29tcG9uZW50IChhY3R1YWxseSBgQmFkZ2VgLCBmb3Igbm93KS4gKi9cbiAgICB0YWdQcm9wczogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm9iamVjdCwgUHJvcFR5cGVzLmZ1bmNdKSxcbiAgICAvKipcbiAgICAgKiBUaGVtZSBwcm92aWRlZCBieSBUaGVtZVByb3ZpZGVyLlxuICAgICAqL1xuICAgIHRoZW1lOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgLyoqIENvbnRyb2xsZWQgdGFnIHZhbHVlcy4gRWFjaCB2YWx1ZSBpcyByZW5kZXJlZCBpbnNpZGUgYSB0YWcuICovXG4gICAgdmFsdWVzOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMubm9kZSlcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgYWRkT25CbHVyOiBmYWxzZSxcbiAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgaGVpZ2h0OiAzMixcbiAgICBzZXBhcmF0b3I6IC9bLFxcblxccl0vLFxuICAgIHZhbHVlczogW10sXG4gICAgdGFnUHJvcHM6IHt9XG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICBpbnB1dFZhbHVlOiAnJyxcbiAgICBpc0ZvY3VzZWQ6IGZhbHNlXG4gIH1cblxuICBpZCA9IGBUYWdJbnB1dC0ke2lucHV0SWQrK31gXG5cbiAgYWRkVGFncyA9ICh2YWx1ZSA9ICcnKSA9PiB7XG4gICAgY29uc3QgeyBvbkFkZCwgb25DaGFuZ2UsIHZhbHVlcyB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG5ld1ZhbHVlcyA9IHRoaXMuZ2V0VmFsdWVzKHZhbHVlKVxuICAgIGxldCBzaG91bGRDbGVhcklucHV0ID0gc2FmZUludm9rZShvbkFkZCwgbmV3VmFsdWVzKVxuXG4gICAgaWYgKHR5cGVvZiBvbkNoYW5nZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgc2hvdWxkQ2xlYXJJbnB1dCA9IHNob3VsZENsZWFySW5wdXQgfHwgb25DaGFuZ2UodmFsdWVzLmNvbmNhdChuZXdWYWx1ZXMpKVxuICAgIH1cblxuICAgIGlmIChzaG91bGRDbGVhcklucHV0ICE9PSBmYWxzZSkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IGlucHV0VmFsdWU6ICcnIH0pXG4gICAgfVxuICB9XG5cbiAgZ2V0VmFsdWVzID0gKGlucHV0VmFsdWUgPSAnJykgPT4ge1xuICAgIGNvbnN0IHsgc2VwYXJhdG9yIH0gPSB0aGlzLnByb3BzXG5cbiAgICByZXR1cm4gc2VwYXJhdG9yXG4gICAgICA/IGlucHV0VmFsdWVcbiAgICAgICAgICAuc3BsaXQoc2VwYXJhdG9yKVxuICAgICAgICAgIC5tYXAodiA9PiB2LnRyaW0oKSlcbiAgICAgICAgICAuZmlsdGVyKHYgPT4gdi5sZW5ndGggPiAwKVxuICAgICAgOiBbaW5wdXRWYWx1ZV1cbiAgfVxuXG4gIGhhbmRsZUJhY2tzcGFjZVRvUmVtb3ZlID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgdmFsdWVzIH0gPSB0aGlzLnByb3BzXG5cbiAgICAvLyBEZWxldGUgbGFzdCBpdGVtIGluIHZhbHVlc1xuICAgIHRoaXMucmVtb3ZlVGFnQXRJbmRleCh2YWx1ZXMubGVuZ3RoIC0gMSlcbiAgfVxuXG4gIGhhbmRsZUJsdXIgPSBldmVudCA9PiB7XG4gICAgY29uc3QgY29udGFpbmVyID0gZXZlbnQudGFyZ2V0XG5cbiAgICAvLyBVc2UgcmFmIHNvIHRoYXQgdGhlIGRvbSBoYXMgdGltZSB0byB1cGRhdGUgYGFjdGl2ZUVsZW1lbnRgXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmICghY29udGFpbmVyLmNvbnRhaW5zKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpKSB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLmFkZE9uQmx1ciAmJiB0aGlzLnN0YXRlLmlucHV0VmFsdWUpIHtcbiAgICAgICAgICB0aGlzLmFkZFRhZ3ModGhpcy5zdGF0ZS5pbnB1dFZhbHVlKVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGlzRm9jdXNlZDogZmFsc2UgfSlcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgc2FmZUludm9rZSh0aGlzLnByb3BzLm9uQmx1ciwgZXZlbnQpXG4gIH1cblxuICBoYW5kbGVJbnB1dENoYW5nZSA9IGV2ZW50ID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHsgaW5wdXRWYWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlIH0pXG4gICAgc2FmZUludm9rZSh0aGlzLnByb3BzLm9uSW5wdXRDaGFuZ2UsIGV2ZW50KVxuICB9XG5cbiAgaGFuZGxlSW5wdXRGb2N1cyA9IGV2ZW50ID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHsgaXNGb2N1c2VkOiB0cnVlIH0pXG4gICAgc2FmZUludm9rZSh0aGlzLnByb3BzLm9uRm9jdXMsIGV2ZW50KVxuICB9XG5cbiAgaGFuZGxlS2V5RG93biA9IGV2ZW50ID0+IHtcbiAgICBjb25zdCB7IHNlbGVjdGlvbkVuZCwgdmFsdWUgfSA9IGV2ZW50LnRhcmdldFxuXG4gICAgaWYgKGV2ZW50LmtleSA9PT0gJ0VudGVyJykge1xuICAgICAgLy8gUHJldmVudCBFbnRlciBrZXlwcmVzc2VzIGZyb20gc3VibWl0dGluZyBmb3JtcyBzaW5jZSB0aGV5IGhhdmUgc3BlY2lhbCBwb3dlcnMgaW5zaWRlIFRhZ0lucHV0XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICB0aGlzLmFkZFRhZ3ModmFsdWUpXG4gICAgfSBlbHNlIGlmIChldmVudC5rZXkgPT09ICdCYWNrc3BhY2UnICYmIHNlbGVjdGlvbkVuZCA9PT0gMCkge1xuICAgICAgdGhpcy5oYW5kbGVCYWNrc3BhY2VUb1JlbW92ZShldmVudClcbiAgICB9XG4gIH1cblxuICBoYW5kbGVSZW1vdmVUYWcgPSBldmVudCA9PiB7XG4gICAgLy8gVXNpbmcgZGF0YSBhdHRyaWJ1dGUgdG8gc2ltcGxpZnkgY2FsbGJhY2sgbG9naWMgLS0gb25lIGhhbmRsZXIgZm9yIGFsbCBjaGlsZHJlblxuICAgIGNvbnN0IGluZGV4ID0gTnVtYmVyKFxuICAgICAgZXZlbnQuY3VycmVudFRhcmdldC5wYXJlbnRFbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10YWctaW5kZXgnKVxuICAgIClcbiAgICB0aGlzLnJlbW92ZVRhZ0F0SW5kZXgoaW5kZXgpXG4gIH1cblxuICBtYXliZVJlbmRlclRhZyA9ICh0YWcsIGluZGV4KSA9PiB7XG4gICAgaWYgKCF0YWcpIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgY29uc3QgeyBkaXNhYmxlZCwgdGFnUHJvcHMgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCBwcm9wcyA9IHNhZmVJbnZva2UodGFnUHJvcHMsIHRhZywgaW5kZXgpIHx8IHRhZ1Byb3BzXG5cbiAgICByZXR1cm4gKFxuICAgICAgPFRhZ1xuICAgICAgICBrZXk9e2Ake3RhZ306JHtpbmRleH1gfVxuICAgICAgICBkYXRhLXRhZy1pbmRleD17aW5kZXh9XG4gICAgICAgIG1hcmdpblJpZ2h0PXttYWpvclNjYWxlKDEpfVxuICAgICAgICBtYXJnaW5ZPVwiNnB4XCJcbiAgICAgICAgb25SZW1vdmU9e2Rpc2FibGVkID8gbnVsbCA6IHRoaXMuaGFuZGxlUmVtb3ZlVGFnfVxuICAgICAgICBpc1JlbW92YWJsZT17IWRpc2FibGVkfVxuICAgICAgICB7Li4ucHJvcHN9XG4gICAgICA+XG4gICAgICAgIHt0YWd9XG4gICAgICA8L1RhZz5cbiAgICApXG4gIH1cblxuICByZW1vdmVUYWdBdEluZGV4ID0gaW5kZXggPT4ge1xuICAgIGNvbnN0IHsgb25DaGFuZ2UsIG9uUmVtb3ZlLCB2YWx1ZXMgfSA9IHRoaXMucHJvcHNcbiAgICBzYWZlSW52b2tlKG9uUmVtb3ZlLCB2YWx1ZXNbaW5kZXhdLCBpbmRleClcblxuICAgIC8vIFJlbW92ZSBpdGVtIGF0IGluZGV4IGFzIGEgbmV3IGFycmF5XG4gICAgY29uc3QgbmV3VmFsdWVzID0gdmFsdWVzLmZpbHRlcigoXywgaSkgPT4gaSAhPT0gaW5kZXgpXG4gICAgc2FmZUludm9rZShvbkNoYW5nZSwgbmV3VmFsdWVzKVxuICB9XG5cbiAgc2V0UmVmID0gbm9kZSA9PiB7XG4gICAgdGhpcy5pbnB1dCA9IG5vZGVcbiAgICBzYWZlSW52b2tlKHRoaXMucHJvcHMuaW5wdXRSZWYsIG5vZGUpXG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgYWRkT25CbHVyLFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgZGlzYWJsZWQsXG4gICAgICBoZWlnaHQsXG4gICAgICBpbnB1dFByb3BzLFxuICAgICAgaW5wdXRSZWYsXG4gICAgICBvbkFkZCxcbiAgICAgIG9uQ2hhbmdlLFxuICAgICAgb25JbnB1dENoYW5nZSxcbiAgICAgIG9uUmVtb3ZlLFxuICAgICAgc2VwYXJhdG9yLFxuICAgICAgdGFnUHJvcHMsXG4gICAgICB0aGVtZSxcbiAgICAgIHZhbHVlcyxcbiAgICAgIC4uLnByb3BzXG4gICAgfSA9IHRoaXMucHJvcHNcblxuICAgIGNvbnN0IHsgaW5wdXRWYWx1ZSwgaXNGb2N1c2VkIH0gPSB0aGlzLnN0YXRlXG5cbiAgICBjb25zdCB0aGVtZWRDb250YWluZXJDbGFzc05hbWUgPSB0aGVtZS5nZXRUYWdJbnB1dENsYXNzTmFtZSgnZGVmYXVsdCcpXG4gICAgY29uc3QgdGhlbWVkSW5wdXRDbGFzc05hbWUgPSB0aGVtZS5nZXRUZXh0SW5wdXRDbGFzc05hbWUoJ25vbmUnKVxuICAgIGNvbnN0IHRleHRTaXplID0gdGhlbWUuZ2V0VGV4dFNpemVGb3JDb250cm9sSGVpZ2h0KGhlaWdodClcbiAgICBjb25zdCBib3JkZXJSYWRpdXMgPSB0aGVtZS5nZXRCb3JkZXJSYWRpdXNGb3JDb250cm9sSGVpZ2h0KGhlaWdodClcblxuICAgIHJldHVybiAoXG4gICAgICA8Qm94XG4gICAgICAgIGFyaWEtZGlzYWJsZWQ9e2Rpc2FibGVkIHx8IHVuZGVmaW5lZH1cbiAgICAgICAgYXJpYS1hY3RpdmVkZXNjZW5kYW50PXtpc0ZvY3VzZWQgPyB0aGlzLmlkIDogdW5kZWZpbmVkfVxuICAgICAgICBib3JkZXJSYWRpdXM9e2JvcmRlclJhZGl1c31cbiAgICAgICAgY2xhc3NOYW1lPXtjeCh0aGVtZWRDb250YWluZXJDbGFzc05hbWUsIGNsYXNzTmFtZSl9XG4gICAgICAgIHBhZGRpbmdMZWZ0PXtNYXRoLnJvdW5kKGhlaWdodCAvIDMuMil9XG4gICAgICAgIHBhZGRpbmdSaWdodD17TWF0aC5yb3VuZChoZWlnaHQgLyAzLjIpfVxuICAgICAgICBwYWRkaW5nWT1cIjJweFwiXG4gICAgICAgIHsuLi5wcm9wc31cbiAgICAgICAgb25CbHVyPXt0aGlzLmhhbmRsZUJsdXJ9XG4gICAgICA+XG4gICAgICAgIHt2YWx1ZXMubWFwKHRoaXMubWF5YmVSZW5kZXJUYWcpfVxuICAgICAgICA8VGV4dFxuICAgICAgICAgIGlzPVwiaW5wdXRcIlxuICAgICAgICAgIGlkPXt0aGlzLmlkfVxuICAgICAgICAgIGNvbG9yPXtkaXNhYmxlZCA/ICdtdXRlZCcgOiB1bmRlZmluZWR9XG4gICAgICAgICAgZGlzYWJsZWQ9e2Rpc2FibGVkfVxuICAgICAgICAgIGZsZXhHcm93PVwiMVwiXG4gICAgICAgICAgaGVpZ2h0PXtoZWlnaHQgLSA0fVxuICAgICAgICAgIHNpemU9e3RleHRTaXplfVxuICAgICAgICAgIHR5cGU9XCJ0ZXh0XCJcbiAgICAgICAgICB2YWx1ZT17aW5wdXRWYWx1ZX1cbiAgICAgICAgICB7Li4uaW5wdXRQcm9wc31cbiAgICAgICAgICBjbGFzc05hbWU9e3RoZW1lZElucHV0Q2xhc3NOYW1lfVxuICAgICAgICAgIHJlZj17dGhpcy5zZXRSZWZ9XG4gICAgICAgICAgb25DaGFuZ2U9e3RoaXMuaGFuZGxlSW5wdXRDaGFuZ2V9XG4gICAgICAgICAgb25Gb2N1cz17dGhpcy5oYW5kbGVJbnB1dEZvY3VzfVxuICAgICAgICAgIG9uS2V5RG93bj17dGhpcy5oYW5kbGVLZXlEb3dufVxuICAgICAgICAvPlxuICAgICAgPC9Cb3g+XG4gICAgKVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHdpdGhUaGVtZShUYWdJbnB1dClcbiJdfQ==